<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <link rel="icon" href="./assets/img/logo/logo de aplicacion.png" type="image/x-icon">
    <title>Registro De Usuario</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/startbootstrap-freelancer-gh-pages/css/registro.css">
</head>

<body>
    <section id="sectionLogo">
        <img class="presentacionLogo" id="presentacionLogo"
            src="/startbootstrap-freelancer-gh-pages/assets/img/logo/logo tortu.png" alt="">
    </section>

    <section id="sectionLogin" class="h-100 gradient-form">
        <div class="container"
            style="display: flex; justify-content: center; align-items: center; flex-direction: column-reverse; min-height: 100vh;">
            <div class="row">
                <div class="col-xl-10">
                    <div id="cardSing" class="card">
                        <div class="text-center">
                            <div>
                                <img id="train" class="logo-registro"
                                    src="/startbootstrap-freelancer-gh-pages/assets/img/logo/Bienvenido.png" alt="logo"
                                    width="500">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="card-body">
                                    <form class="form" id="registroForm" onsubmit="guardarNombre(event)">
                                        <div class="text-center">
                                            <label class="form-label"><strong>NOMBRE</strong></label>
                                        </div>
                                        <div class="nombreForm">
                                            <div class="form-outline mb-4 position-relative">
                                                <input type="text" name="nombre" id="nombre" class="form-control"
                                                    placeholder="Nombre" autofocus style="width: 100%;">
                                            </div>
                                            <button type="button" id="micBtn" class="btn btn-primary ms-2">
                                                <i class="bi bi-mic-fill"></i>
                                            </button>
                                        </div>
                                        <br>
                                        <button type="submit" id="guardar" class="btn btn-warning w-100"><i
                                                class="bi bi-door-closed"></i></button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>

        /* Crear nubes dinámicamente */
        for (let i = 0; i < 10; i++) {
            const cloud = document.createElement('div');
            cloud.className = 'cloud';
            cloud.style.width = `${Math.random() * 50 + 10}px`;
            cloud.style.height = cloud.style.width;
            cloud.style.top = `${Math.random() * 100}vh`;
            cloud.style.animationDuration = `${Math.random() * 5 + 5}s`;
            document.body.appendChild(cloud);
        }

        const card = document.getElementById('cardSing'); // Tarjeta de registro
        const seccionLogo = document.getElementById('sectionLogo'); //seccion de presentacion del logo
        const seccionRegistro = document.getElementById('sectionLogin'); //seccion de registro
        const btnStart = document.getElementById('micBtn'); // Botón para activar el micrófono
        const nombre = document.getElementById('nombre'); // Input donde se almacena el nombre


        const recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'es-ES';
        recognition.interimResults = false;

        const mensajeBienvenida = "Bienvenido a Tortulingo, Para empezar, necesitamos saber tu nombre. Pulsa el botón azul y di tu nombre en voz alta. Luego, pulsa el botón amarillo para ingresar, Dentro de la aplicación encontraras tres modúlos de diferentes aprendizajes.";

        // Función para leer el mensaje de bienvenida
        function leerBienvenida() {
            const speech = new SpeechSynthesisUtterance(mensajeBienvenida);
            speech.volume = 2;
            speech.rate = 1.5;
            speech.pitch = 0.4;
            speech.lang = 'es-ES';

            window.speechSynthesis.speak(speech);
        }

        // Escuchar el evento DOMContentLoaded para leer la bienvenida una vez al cargar la página
        window.addEventListener("DOMContentLoaded", function () {
            leerBienvenida();
        });
        //presentacion del logo
        seccionRegistro.style.display = "none"

        // Frases iniciales a eliminar
        const frasesEliminar = [
            "hola mi nombre es",
            "mi nombre es",
            "me llamo",
            "nombres",
            "hola",
            "soy"
        ];

        // Activar el micrófono
        btnStart.addEventListener("click", () => {
            recognition.start();
        });

        // Procesar el texto reconocido y extraer solo el nombre
        recognition.onresult = (event) => {
            let textoReconocido = event.results[event.results.length - 1][0].transcript.toLowerCase();

            // Eliminar las frases iniciales si están presentes
            frasesEliminar.forEach(frase => {
                if (textoReconocido.startsWith(frase)) {
                    textoReconocido = textoReconocido.replace(frase, "").trim(); // Elimina la frase y espacios extra
                }
            });

            // Almacenar solo el nombre en el input
            nombre.value = textoReconocido;
            nombre.focus();
        };

        // Función para guardar el nombre
        function guardarNombre(event) {
            event.preventDefault(); // Evita que el formulario se envíe de forma predeterminada

            const nombreValue = nombre.value.trim();
            if (!nombreValue) {
                card.style.background = "#ff0000aa";
                setTimeout(() => {
                    card.style.background = "#ffffffcf";
                }, 2000);
                return;
            }

            console.log("Enviando nombre:", nombreValue); // Para verificar que se está enviando correctamente

            fetch("http://127.0.0.1:3000/agregar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ nombre: nombreValue })
            })
                .then(response => response.json())
                .then(data => {
                    console.log("Respuesta del servidor:", data); // Para ver la respuesta
                    const wellUser = 'Bienvenido ' + nombreValue + '';
                    if (data.mensaje === "Nombre registrado con éxito") {
                        // Si el nombre es nuevo o ya estaba registrado, redirige a index.html
                        window.location.href = 'First.html';
                        function BienvenidoUser() {
                            const speech = new SpeechSynthesisUtterance(wellUser);
                            speech.lang = 'es-ES';
                            window.speechSynthesis.speak(speech);
                        };
                        BienvenidoUser()
                    } else {
                        // Si el nombre ya está registrado, aún redirige sin alertas
                        window.location.href = 'First.html';
                        window.location.href = 'First.html';
                        function BienvenidoUser() {
                            const speech = new SpeechSynthesisUtterance(wellUser);
                            speech.lang = 'es-ES';
                            window.speechSynthesis.speak(speech);
                        };
                        BienvenidoUser()
                    }
                })
                .catch(error => {
                    console.error('Error al guardar el nombre:', error);
                    alert("Error al guardar el nombre. Inténtalo de nuevo.");
                });
        }

        window.addEventListener("load", function () {
            document.getElementById("presentacionLogo").classList.add("show");

            //ocultar el logo depues de 3s
            setTimeout(() => {
                seccionLogo.style.display = "none";
                seccionRegistro.style.display = "block";
            }, 5000)
        });
    </script>
</body>

</html>